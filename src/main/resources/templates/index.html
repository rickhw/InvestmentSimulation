<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ETF 投資模擬器 (Web)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">ETF Simulator</a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <!-- Input Panel -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">模擬設定</h5>
                </div>
                <div class="card-body">
                    <form action="#" th:action="@{/simulate}" method="post">
                        <div class="mb-3">
                            <label for="etf" class="form-label">選擇 ETF</label>
                            <select class="form-select" id="etf" name="etf">
                                <option th:each="e : ${etfs}" th:value="${e}" th:text="${e}" th:selected="${e == selectedEtf}"></option>
                            </select>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col">
                                <label for="startYear" class="form-label">開始年份</label>
                                <select class="form-select" id="startYear" name="startYear">
                                    <option th:each="year : ${#numbers.sequence(2003, 2024)}" 
                                            th:value="${year}" th:text="${year}" 
                                            th:selected="${year == startYear}"></option>
                                </select>
                            </div>
                            <div class="col">
                                <label for="startMonth" class="form-label">開始月份</label>
                                <select class="form-select" id="startMonth" name="startMonth">
                                    <option th:each="month : ${#numbers.sequence(1, 12)}" 
                                            th:value="${month}" th:text="${month}"
                                            th:selected="${month == startMonth}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="initialInvestment" class="form-label">初始金額</label>
                            <input type="number" class="form-control" id="initialInvestment" name="initialInvestment" th:value="${initialInvestment}" step="1000">
                        </div>

                        <div class="mb-3">
                            <label for="monthlyInvestment" class="form-label">每月定期定額</label>
                            <input type="number" class="form-control" id="monthlyInvestment" name="monthlyInvestment" th:value="${monthlyInvestment}" step="1000">
                        </div>

                        <button type="submit" class="btn btn-primary w-100">開始模擬</button>
                    </form>
                </div>
            </div>
            
            <!-- Summary Result -->
            <div class="card shadow-sm mb-4" th:if="${results != null}">
                <div class="card-header bg-white">
                    <h5 class="mb-0">模擬結果摘要</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            總投入成本
                            <span class="fw-bold" th:text="${#numbers.formatDecimal(totalCost, 0, 'COMMA', 0, 'POINT')}">0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            最終總資產
                            <span class="fw-bold text-primary" th:text="${#numbers.formatDecimal(finalValue, 0, 'COMMA', 0, 'POINT')}">0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            總損益
                            <span class="fw-bold" th:classappend="${profit >= 0} ? 'text-success' : 'text-danger'" 
                                  th:text="${#numbers.formatDecimal(profit, 0, 'COMMA', 0, 'POINT')}">0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            報酬率 (ROI)
                            <span class="fw-bold" th:classappend="${roi >= 0} ? 'text-success' : 'text-danger'" 
                                  th:text="${#numbers.formatDecimal(roi, 1, 'POINT', 2, 'POINT')} + '%'">0%</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Chart and Table Panel -->
        <div class="col-md-8">
            <div class="card shadow-sm mb-4" th:if="${results != null}">
                <div class="card-header bg-white">
                    <h5 class="mb-0">資產成長趨勢</h5>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="card shadow-sm" th:if="${results != null}">
                <div class="card-header bg-white">
                    <h5 class="mb-0">詳細數據</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>日期</th>
                                    <th>總投入成本</th>
                                    <th>總資產價值</th>
                                    <th>損益</th>
                                    <th>報酬率</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="point : ${results}">
                                    <td th:text="${point.date}"></td>
                                    <td th:text="${#numbers.formatDecimal(point.cost, 0, 'COMMA', 0, 'POINT')}"></td>
                                    <td th:text="${#numbers.formatDecimal(point.value, 0, 'COMMA', 0, 'POINT')}"></td>
                                    <td th:text="${#numbers.formatDecimal(point.value - point.cost, 0, 'COMMA', 0, 'POINT')}"
                                        th:class="${(point.value - point.cost) >= 0} ? 'text-success' : 'text-danger'"></td>
                                    <td th:text="${#numbers.formatDecimal((point.cost > 0 ? (point.value - point.cost) / point.cost * 100 : 0), 1, 'POINT', 2, 'POINT') + '%'}"
                                        th:class="${(point.value - point.cost) >= 0} ? 'text-success' : 'text-danger'"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:if="${results != null}" th:inline="javascript">
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const labels = [[${chartLabels}]];
    const values = [[${chartValues}]];
    const costs = [[${chartCosts}]];

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '總資產價值',
                    data: values,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.1
                },
                {
                    label: '總投入成本',
                    data: costs,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: true,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
